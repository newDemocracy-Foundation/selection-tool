<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">

	<title>Stratified Random Selection Tool</title>

	<!-- CSS -->
	<link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="css/main.css"/>

	<script src="https://kit.fontawesome.com/3e29baf0d8.js" crossorigin="anonymous"></script>

	<!-- JavaScript -->
	<script type="text/javascript" src="/js/xlsx.core.min.js"></script>
	<script type="text/javascript" src="/js/math.min.js"></script>
	<!--<script src="https://unpkg.com/javascript-lp-solver/prod/solver.js"></script>-->
	<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha256-4+XzXVhsDmqanXGHaHvgh1gMQKX40OUvDEBTu8JcmNs=" crossorigin="anonymous"></script>

	<!-- Favicon -->
	<link rel="icon" href="favicon.ico"  type="image/ico">

</head>

<body>

	<header>
		<div class="title">Stratified Random Selection Tool</div>
		<div class="logo"><a href="https://www.newdemocracy.com.au/"><img src="img/logo.png" /></a></div>
	</header>

	<main>
		<div class="notification"><i class="fas fa-megaphone"></i>&ensp;&ensp;This tool is still a work in progress, but should be functional. <a href="mailto:kyle.redman@newdemocracy.com.au" class="intext">Let us know</a> if you get stuck.</div>
		
		<nav class="top">
			<div class="tab active" data-pane="about">About</div>
			<div class="tab" data-pane="import">Import data</div>
			<div class="tab" data-pane="settings">Choose settings</div>
			<div class="tab" data-pane="run">Run selection</div>
			<div class="tab" data-pane="export">Export selection</div>
		</nav>

		<div id="progress" class="progress" style="width: 20%;"></div>

		<div class="pane" data-pane="about">


			<div class="text-wrap">

				<p>Emerging models of public deliberation&mdash;such as <a class="intext" target="_blank" rel="noopener noreferrer" href="https://newdemocracy.com.au/wp-content/uploads/2017/05/docs_researchnotes_2017_May_nDF_RN_20170508_FormsOfMiniPublics.pdf">citizens' juries, citizens' assemblies or deliberative polls</a>&mdash;require that the participants be randomly selected. Usually it is desirable for the random selection to be <em>stratified</em>: that is, to be representative of the general population along dimensions such as age, gender, nationality or socio-economic status.</p>

				<p>This tool makes it easier to perform such stratified random selection.</p>

				<h2>Who is providing this tool?</h2>

				<p>This tool is made available by the <a class="intext" target="_blank" rel="noopener noreferrer" href="https://www.newdemocracy.com.au/">newDemocracy Foundation</a>, an independent, non-partisan research and development organisation. We aim to discover, develop, demonstrate, and promote complementary alternatives which will restore trust in public decision making.</p>

				<h2>Why should I trust it?</h2>

				<p>To maintain the integrity of a mini-public, it is important when selecting participants</p>

				<ol style="list-style-type: lower-alpha;">
					<li>that the selection is genuinely random, and</li>
					<li>that personal information about the candidates is kept private.</li>
				</ol>

				<p>To this end, this selection tool has the following features.</p>

				<dl>
					<dt>Open source</dt>
					<dd>
						<p>The source code for this tool is publicly available and can be found in <a href="https://github.com/newDemocracy-Foundation/selection-tool" target="_blank" rel="noopener noreferrer" class="intext">this GitHub repository</a>.</p>
						<p>To ensure you are using the code that is in the GitHub repository, you can access this page via the following direct link on the GitHub Pages domain.</p>
						<pre>https://newDemocracy-Foundation.github.io/selection-tool/</pre>
					</dd>

					<dt>Runs locally</dt>
					<dd>
						<p>The selection algorithm will run locally in your browser. The tool will work even if you disconnect from the internet (after initially loading the tool).</p>
						<p>The tool does not upload any data (including data that you input, such as candidate information) to the internet.</p>
						<p>If you are using any browser extensions, it is possible that you have previously granted them permission to access the data on pages that you visit, including this tool. If privacy is a concern, we suggest you temporarily disable your browser extensions whilst performing the selection to ensure they do not have access to candidate information.</p>
					</dd>
					
				</dl>

				<h2>What do I need?</h2>

				To use the tool, you need two sets of information.

				<ul>
					<li>A spreadsheet containing demographic information for each of the eligible candidates. To understand the required formatting, please refer to this example <a class="intext" href="data/example-people-simple.xlsx">Excel spreadsheet</a>, or this <a class="intext" href="/data/example-people-simple.csv">CSV file</a>.<br /><br /></li>
					<li>A spreadsheet containing information about the distribution of demographic factors in the population for which you want your random sample to be representative. To understand the required formatting, please refer to this example <a class="intext" href="data/example-categories-simple.xlsx">Excel spreadsheet</a>, or this <a class="intext" href="/data/example-categories-simple.csv">CSV file</a>.</li>
				</ul>

				<h2>Getting Help</h2>

				<p>If you need help using the tool or understanding if it is right for your situation, please contact Kyle Redman at <a class="intext" href="mailto:kyle.redman@newdemocracy.com.au ">kyle.redman@newdemocracy.com.au</a>.</p>

				<p>If you have any technical questions, bug reports, or suggested improvements, please <a href="https://github.com/newDemocracy-Foundation/selection-tool/issues" target="_blank" rel="noopener noreferrer" class="intext">open an issue</a> in the <a href="https://github.com/newDemocracy-Foundation/selection-tool" target="_blank" rel="noopener noreferrer" class="intext">GitHub repository</a>.</p>

				<h2>One final note</h2>

				<p>Be aware that depending on the particular makeup of your pool of candidates, and the specifications of the stratified sample you are trying to obtain, it is possible that the tool may not be able to find a valid sample. If this occurs, the tool will inform you.</p>

				<div class="acknowledgements">
					
					<p>This tool makes use of the following JavaScript libraries: <a href="https://github.com/JWally/jsLPSolver" target="_blank" rel="noopener noreferrer" class="intext">jsLPsolver</a>, <a href="https://github.com/SheetJS/sheetjs" target="_blank" rel="noopener noreferrer" class="intext">SheetJS</a> and <a href="https://mathjs.org/" target="_blank" rel="noopener noreferrer" class="intext">mathjs</a>. The code is modelled on a similar <a href="https://github.com/sortitionfoundation/stratification-app" target="_blank" rel="noopener noreferrer" class="intext">Python-based selection tool</a> developed by the <a href="https://www.sortitionfoundation.org/" target="_blank" rel="noopener noreferrer" class="intext">Sortition Foundation</a>.</p>

				</div>



			</div>

			<nav class="bottom">
				<div class="tab inactive"></div>
				<div class="tab" data-pane="import"></div>
			</nav>

		</div>

		<div class="pane hide" data-pane="import">

			<div class="two-column">

				<div>
					<h3>First, import your <strong>candidate information</strong>...</h3>
					<div id="dragdrop-people" class="filedrop">
						<span class="msg-nofile">Drag and drop a CSV or Excel file here.</span>
						<span class="msg-file"><span id="filename-people" class="filename"></span><button id="remove-people" class="remove-button">Click to remove &#215;</button></span>
						<input id="browse-people" type="file" class="filebrowse" />
					</div>
					<p>To understand the required format for the candidate information, you can download example candidate information as <a class="intext" href="data/example-people-simple.csv">CSV</a>, <a class="intext" href="data/example-people-simple.xlsx">Excel</a>.</p>
				</div>

				<div>
					<h3>...then, import your <strong>population profile</strong>.</h3>
					<div id="dragdrop-variables" class="filedrop">
						<span class="msg-nofile">Drag and drop a CSV or Excel file here.</span>
						<span class="msg-file"><span id="filename-variables" class="filename"></span><button id="remove-variables" class="remove-button">Click to remove &#215;</button></span>
						<input id="browse-variables" type="file" class="filebrowse" />
					</div>
					<p>To understand the required format for the population profile, you can download example population profile as <a class="intext" href="data/example-categories-simple.csv">CSV</a>, <a class="intext" href="data/example-categories-simple.xlsx">Excel</a>.</p>
				</div>

			</div>

			<p>If you just want to see how the tool works, <a href="#" id="loadExampleData" class="intext">click here</a> to load the example data.</p>

			<nav class="bottom">
				<div class="tab" data-pane="about"></div>
				<div class="tab" data-pane="settings"></div>
			</nav>

		</div>

		<div class="pane hide" data-pane="settings">

			<h3>Selection Algorithm:</h3>

			<div class="algorithms">
				<div id="alg-simple" class="algorithm" onclick="selectAlg('simple')">
					<span class="alg-name">Simple</span>
					<p>In this algorithm, first a number of panels are generated which satisfy the specified constraints, and then one of those panels is selected at random.</p>
					<span class="alg-pro">Pros</span>
					<ul>
						<li>Should work every time.</li>
						<li>Relatively fast.</li>
					</ul>
					<span class="alg-con">Cons</span>
					<ul>
						<li>Not always fair to individuals because some individuals will be represented in more of the panels than others.</li>
					</ul>
				</div>
				<div id="alg-maximin" class="algorithm" onclick="selectAlg('maximin')">
					<span class="alg-name">Maximin</span>
					<p>In this algorithm, first a number of panels are generated which satisfy the specified constraints, then probabilities are assigned to each of the panels such that the minimum probability than any particular candidate is selected is maximised, and then a panel is selected according to that probability distribution.</p>
					<span class="alg-pro">Pros</span>
					<ul>
						<li>Much fairer to individuals than the Simple algorithm.</li>
					</ul>
					<span class="alg-con">Cons</span>
					<ul>
						<li>A bit slower.</li>
						<li>Might not work. The algorithm can get stuck part way through on larger problems.</li>
					</ul>
				</div>
			</div>

			<h3>Other Settings:</h3>

			<div class="option alg-simple alg-maximin">
				<span class="opt-name">How many people should be selected?</span>
				<input type="number" name="n-to-select" id="n-to-select" placeholder="Enter a number..." />
				<span class="opt-explanation">The number of people to select. This should be compatible with the numbers you specified in the Population Profile you uploaded in Step 2. <span id="bounds"></span></span>

			</div>

			<div class="option alg-simple alg-maximin">
				<span class="opt-name">Only 1 per household</span>
				<div class="input">
					<input type="checkbox" name="check-same-address" id="checkSameAddress" class="switch" checked />
				</div>
				<span class="opt-explanation">When toggled on, the selected panel will include at most 1 person from each household. Households are determined by each candidate's address, as specified by two columns in the Candidate Information spreadsheet you uploaded in Step 2: 'address' and 'postcode'.</span>
			</div>

			<div class="option alg-maximin hide">
				<span class="opt-name">Fair to households?</span>
				<div class="input">
					<input type="checkbox" name="fair-to-housholds" id="fairToHouseholds" class="switch" />
				</div>
				<span class="opt-explanation">When toggled on, the algorithm will aim to maximise the minimum expected number of candidates selected from each household, rather than the minimum probability that any individual is selected.</span>
			</div>


			<nav class="bottom">
				<div class="tab" data-pane="import"></div>
				<div class="tab" data-pane="run"></div>
			</nav>

		</div>

		<div class="pane hide" data-pane="run">

			<div id="run" class="button run-button">Run Selection</div>

			<div id="log" class="log">

			</div>

			<nav class="bottom">
				<div class="tab" data-pane="settings"></div>
				<div class="tab" data-pane="export"></div>
			</nav>

		</div>

		<div class="pane hide" data-pane="export">

			<div class="export-table">
				
				<div>
					<p><strong>Export selected candidates</strong></p>
					<p>Download the details of the candidates who were selected, in your preferred format.</p>
				</div>
				<div id="export-in-csv" class="button">CSV</div>
				<div id="export-in-xlsx" class="button">Excel</div>

				<div>
					<p><strong>Export everyone else</strong></p>
					<p>Download the candidates who were <strong>not</strong> selected. This can sometimes be helpful if you need to choose participants for a future event, or if you have someone withdraw their participation and need to select a replacement.</p></div>
				<div id="export-out-csv" class="button">CSV</div>
				<div id="export-out-xlsx" class="button">Excel</div>

			</div>

			<table id="summary-table" class="summary hide">
				<thead>
					<tr>
						<th class="left">Variable</th>
						<th class="left">Value</th>
						<th># Requested</th>
						<th># Selected</th>
					</tr>
				</thead>
				<tbody id="summary-table-body"></tbody>
			</table>

			<nav class="bottom">
				<div class="tab" data-pane="run"></div>
				<div class="tab inactive"></div>
			</nav>

		</div>

	</main>

	<footer>
		<div>
			<a href="https://www.newdemocracy.com.au/">newDemocracy Foundation</a>
			<br />
			Made available under an <a href="">GPL-3.0 License</a>.
		</div>
		<div class="right">
			Built and maintained by <a href="https://lukethorburn.com/">Luke Thorburn</a>
		</div>
	</footer>
	
	<script type="module" src="js/stratification.js"></script>

	<script>
		function clickTab(event) {
			changeTab(event.srcElement.getAttribute('data-pane'));
		}

		function changeTab(id) {
			
			// Set all tabs to inactive.
			let tabs = document.querySelectorAll('nav div.tab');
			for (let j = 0; j < tabs.length; j++) {
				tabs[j].classList.remove('active');
			}

			// Set clicked tab to active.
			document.querySelector(`.tab[data-pane="${id}"]`)
					.classList.add('active');

			// Hide all panes.
			let panes = document.querySelectorAll('div.pane');
			for (let j = 0; j < panes.length; j++) {
				panes[j].classList.add('hide');
			}

			// Show clicked pane.
			document
				.querySelector(`.pane[data-pane="${id}"]`)
				.classList.remove('hide');

			// Update progress bar.
			let progress = document.getElementById('progress'),
				width;
			switch(id) {
				case 'about':
					width = 20;
					break;
				case 'import':
					width = 40;
					break;
				case 'settings':
					width = 60;
					break;
				case 'run':
					width = 80;
					break;
				case 'export':
					width = 100;
					break;
			}
			progress.setAttribute('style', `width: ${width}%;`);

		}

		let tabs = document.querySelectorAll('nav div.tab');
		for (let i = 0; i < tabs.length; i ++) {
			tabs[i].addEventListener('click', clickTab, false);
		}

		var selectedAlgorithm;

		function selectAlg(alg) {
			
			// Select the algorithm that was clicked.
			let algs = document.querySelectorAll(".algorithm");
			for (let a of algs) {
				a.classList.remove('selected');
			}
			document.querySelector(`#alg-${alg}`).classList.add('selected');
			selectedAlgorithm = alg;

			// Update which other settings are visible.
			let opts = document.querySelectorAll(".option");
			for (let opt of opts) {
				if (opt.classList.contains(`alg-${alg}`)) {
					opt.classList.remove('hide');
				} else {
					opt.classList.add('hide');
				}
			}
		}

		// changeTab('run');
	</script>

</body>

</html>